@inject AuthenticationStateProvider AuthProvider
@inject AuthService AuthService
@inject NavigationManager Nav
@inject HttpClient Http

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="2" Class="p-4 mb-4">
        <MudText Typo="Typo.h4" Class="mb-2">Bienvenido, @userFullName (@userEmail)</MudText>
        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
            Tu resumen financiero del mes y tus indicadores clave.
        </MudText>
    </MudPaper>
    <MudPaper Elevation="2" Class="p-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">Movimiento Financiero Mensual</MudText>
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudDatePicker Label="Desde" @bind-Date="summaryStartDate" />
            </MudItem>
            <MudItem xs="12" md="3" Class="d-flex align-items-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadTransactionsAsync">
                    Filtrar
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Resumen Mensual</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (summary is null)
                    {
                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                        <MudText>Cargando resumen mensual...</MudText>
                    }
                    else
                    {
                        <table class="mud-table">
                            <tr>
                                <td><MudIcon Icon="mdi-cash-plus" Color="Color.Success" /> Ingresos</td>
                                <td>@summary.Income.ToString("C")</td>
                            </tr>
                            <tr>
                                <td><MudIcon Icon="mdi-cash-minus" Color="Color.Error" /> Gastos</td>
                                <td>@summary.Expense.ToString("C")</td>
                            </tr>
                            <tr>
                                <td><MudIcon Icon="mdi-bank" Color="Color.Info" /> Saldo</td>
                                <td>
                                    <MudText Color="@(summary.Balance >= 0 ? Color.Success : Color.Error)" Class="fw-bold">
                                        @summary.Balance.ToString("C")
                                    </MudText>
                                </td>
                            </tr>
                        </table>
                        @if (summary.Balance < 0)
                        {
                            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-2">
                                ¡Atención! El saldo es negativo.
                            </MudAlert>
                        }
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Presupuesto vs Real</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (budget is null)
                    {
                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                        <MudText>Cargando presupuesto...</MudText>
                    }
                    else
                    {
                        <table class="mud-table">
                            <tr>
                                <td><MudIcon Icon="mdi-wallet" Color="Color.Primary" /> Presupuesto</td>
                                <td>@budget.Amount.ToString("C")</td>
                            </tr>
                            <tr>
                                <td><MudIcon Icon="mdi-cash-minus" Color="Color.Error" /> Gastos Reales</td>
                                <td>@summary?.Expense.ToString("C")</td>
                            </tr>
                            <tr>
                                <td><MudIcon Icon="mdi-chart-bar" Color="Color.Info" /> Balance</td>
                                <td>
                                    <MudText Color="@(ExpenseVariance >= 0 ? Color.Success : Color.Error)" Class="fw-bold">
                                        @ExpenseVariance.ToString("C")
                                    </MudText>
                                </td>
                            </tr>
                        </table>
                        @if (CurrentAlertThreshold < budget.AlertThreshold)
                        {
                            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mt-2">
                                ¡Atención! Has superado el umbral de alerta del @budget.AlertThreshold.ToString("F2")%.
                            </MudAlert>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mt-2">
                                Estás dentro del presupuesto.
                            </MudAlert>
                        }
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="2" Class="p-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-2">Gastos diarios</MudText>
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudDatePicker Label="Desde" @bind-Date="expenseStartDate" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudDatePicker Label="Hasta" @bind-Date="expenseEndDate" />
            </MudItem>
            <MudItem xs="12" md="3" Class="d-flex align-items-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDailyTransactionsAsync">
                    Filtrar
                </MudButton>
            </MudItem>
        </MudGrid>
        @if (dailyTransactions == null)
        {
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            <MudText>Cargando gastos diarios…</MudText>
        }
        else
        {
            <MudChart ChartType="ChartType.Bar"
                      ChartSeries="@barSeries"
                      XAxisLabels="@barLabels"
                      Width="100%"
                      Height="350px"
                      AxisChartOptions="_axisChartOptions">
            </MudChart>
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="@barSeries"
                      XAxisLabels="@barLabels"
                      Width="100%"
                      Height="350px"
                      ChartOptions="@_options"
                      AxisChartOptions="_axisChartOptions">
            </MudChart>
        }
    </MudPaper>
</MudContainer>

@code {
    // Estado principal
    private MonthlySummaryDto? summary;
    private BudgetDto? budget;
    private decimal ExpenseVariance;
    private decimal CurrentAlertThreshold;
    private string? userEmail;
    private string? userFullName;
    private DateTime? summaryStartDate;


    // Estado del gráfico de gastos diarios
    private List<DailyTransactionViewDto>? dailyTransactions;
    private DateTime? expenseStartDate;
    private DateTime? expenseEndDate;
    private string[] barLabels = Array.Empty<string>();
    private List<ChartSeries>? barSeries;
    private ChartOptions _options = new ChartOptions();
    private AxisChartOptions _axisChartOptions = new AxisChartOptions();

    protected override async Task OnInitializedAsync()
    {
        userEmail = await AuthService.GetEmailAsync();
        userFullName = await AuthService.GetFullNameAsync();
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        if (!authState.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo("/login", true);
            return;
        }
        var now = DateTime.Now;
        summaryStartDate = new DateTime(now.Year, now.Month, 1);
        expenseStartDate = summaryStartDate;
        expenseEndDate = expenseStartDate.Value.AddMonths(1).AddDays(-1);
        await LoadTransactionsAsync();
        await LoadDailyTransactionsAsync();
    }

    private async Task LoadTransactionsAsync()
    {
        try
        {
            var fm = new DateTime(summaryStartDate!.Value.Year, summaryStartDate!.Value.Month, 1);
            summary = await Http.GetFromJsonAsync<MonthlySummaryDto>(
                $"api/transactions/summary/{fm:yyyy}/{fm:MM}");
            budget = await Http.GetFromJsonAsync<BudgetDto>(
                $"api/budget/{fm:yyyy}/{fm:MM}");
            if (summary is not null && budget is not null)
            {
                ExpenseVariance = budget.Amount - summary.Expense;
                CurrentAlertThreshold = ExpenseVariance / 100;
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error cargando transacciones: {ex.Message}");
            summary = new MonthlySummaryDto();
            budget = new BudgetDto();
        }
    }

    private async Task LoadDailyTransactionsAsync()
    {
        try
        {
            var url = $"api/transactions/daily-expenses" +
                $"?start={expenseStartDate:yyyy-MM-dd}" +
                $"&end={expenseEndDate:yyyy-MM-dd}";
            dailyTransactions = await Http.GetFromJsonAsync<List<DailyTransactionViewDto>>(url)
                ?? new List<DailyTransactionViewDto>();
            if (dailyTransactions?.Any() == true)
            {
                barLabels = dailyTransactions
                    .Select(d => d.Date.ToString("dd"))
                    .ToArray();
                barSeries = new List<ChartSeries>
                {
                    new ChartSeries
                    {
                        Name = "Gastos",
                        Data = dailyTransactions.Select(d => (double)d.ExpenseAmount).ToArray()
                    },
                    new ChartSeries
                    {
                        Name = "Ingresos",
                        Data = dailyTransactions.Select(d => (double)d.IncomeAmount).ToArray()
                    }
                };
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error cargando gastos diarios: {ex.Message}");
            dailyTransactions = new List<DailyTransactionViewDto>();
            barLabels = Array.Empty<string>();
            barSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "Gastos", Data = Array.Empty<double>() },
                new ChartSeries { Name = "Ingresos", Data = Array.Empty<double>() }
            };
        }
    }
}